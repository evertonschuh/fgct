/**
 * Example Plugin for TinyMCE 5 (built with RC1)
 *
 * @author Marty Friedel
 */
 (function () {
    var chart = (function () {
        'use strict';

        tinymce.PluginManager.add("chart", function (editor, url) {

            /*
            Add a custom icon to TinyMCE
             */
            editor.ui.registry.addIcon('bubbles', '<svg width="24" height="24"><use xlink:href="custom-icons.svg#bubbles4"></use></svg>');

            /*
            Use to store the instance of the Dialog
             */
            var _dialog = false;

            /*
            An array of options to appear in the "Type" select box.
             */
            var _typeOptions = [];

            /**
             * Get the Dialog Configuration Object
             *
             * @returns {{buttons: *[], onSubmit: onSubmit, title: string, body: {}}}
             * @private
             */
            function _getDialogConfig()
            {
                return {
                    title: 'Inserir Gráfico',
                    body: {
                        type: 'panel',
                        items: [{
                            type: 'selectbox',
                            name: 'type',
                            label: 'Dropdown',
                            items: _typeOptions,
                            flex: true
                        }]
                    },
                    onSubmit: function (api) {
                        // insert markup
                        editor.insertContent('{{CHART|' + api.getData().type + '}}');

                        // close the dialog
                        api.close();
                    },
                    buttons: [
                        {
                            text: 'Fechar',
                            type: 'cancel',
                            onclick: 'close'
                        },
                        {
                            text: 'Inserir',
                            type: 'submit',
                            primary: true,
                            enabled: false
                        }
                    ]
                };
            }

            /**
             * Plugin behaviour for when the Toolbar or Menu item is selected
             *
             * @private
             */
            function _onAction()
            {
                // Open a Dialog, and update the dialog instance var
                _dialog = editor.windowManager.open(_getDialogConfig());

                // block the Dialog, and commence the data update
                // Message is used for accessibility
                _dialog.block('Carregando...');

                // Do a server call to get the items for the select box
                // We'll pretend using a setTimeout call


                jQuery.post('views/system/includes/dynamicselect.php', 
                    {execute:'getCharts'},
                    function(valor){

                        setTimeout(function () {
                            _typeOptions = jQuery.parseJSON(valor);
                            _dialog.redial(_getDialogConfig());
                            _dialog.unblock();

                        }, 1000);

                    }
                )
            }

            // Define the Toolbar button
            editor.ui.registry.addButton('chart', {
                text: "Inserir Gráfico",
                icon: 'browse',
                onAction: _onAction
            });

            // Define the Menu Item
            editor.ui.registry.addMenuItem('chart', {
                context: 'insert',
                text: "Inserir Gráfico",
                icon: 'browse',
                onAction: _onAction
            });
        });
    }());
})();