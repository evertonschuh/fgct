/**
 * Example Plugin utilising URL Dialog
 *
 * @author Marty Friedel
 */
(function () {
    var src = '';
    var imgmanager = (function () {
        'use strict';

        tinymce.PluginManager.add("imgmanager", function (editor, url) {

            /*
            Used to store a reference to the dialog when we have opened it
             */
            var _api = false;
            var parseIntAndGetMax = function (val1, val2) {
                return Math.max(parseInt(val1, 10), parseInt(val2, 10));
              };
            var global$2 = tinymce.util.Tools.resolve('tinymce.util.Promise');
            var getImageSize = function (url) {
                return new global$2(function (callback) {
                  var img = document.createElement('img');
                  var done = function (dimensions) {
                    if (img.parentNode) {
                      img.parentNode.removeChild(img);
                    }
                    callback(dimensions);
                  };
                  img.onload = function () {
                    var width = parseIntAndGetMax(img.width, img.clientWidth);
                    var height = parseIntAndGetMax(img.height, img.clientHeight);
                    var dimensions = {
                      width: width,
                      height: height
                    };
                    done(global$2.resolve(dimensions));
                  };
                  img.onerror = function () {
                    done(global$2.reject('Failed to get image dimensions for: ' + url));
                  };
                  var style = img.style;
                  style.visibility = 'hidden';
                  style.position = 'fixed';
                  style.bottom = style.left = '0px';
                  style.width = style.height = 'auto';
                  document.body.appendChild(img);
                  img.src = url;
                });
              };


            /*
            Define configuration for the imgmanager
             */
            var _urlDialogConfig = {
                title: 'Inserir Imagem da Galeira',
                url: '/admin/index.php?view=imgmanager&layout=modal&tmpl=modal',
                buttons: [
                    {
                        type: 'custom',
                        name: 'action1',
                        text: 'Incluir',
                        primary: true,
                        align: 'end'
                    },
                    {
                        type: 'cancel',
                        name: 'cancel',
                        text: 'Fechar',
                        primary: false,
                        align: 'end'
                    }
                ],
                onAction: function (instance, trigger) {
                   // return false;

                    

                    if(trigger.name == 'action1' )	{
                        if(src != ''){
                            instance.block('Aguarde...');
                            setTimeout(() => {
                                // insert some content            
                                editor.insertContent('<img src="' + src + '" />');
                                // close the dialog
                                instance.close();
                            }, 1000);
                        }
                        else {
                            editor.windowManager.alert('Nenhuma imagem foi selecionada.');
                            return false;
                        }
                        


                    }
                    else {
                        setTimeout(() => {
                            // insert some content

                            instance.close();
                        }, 1000);
                    }

                },
                onMessage: function (instance, data) {
                   // alert('2');
                    // what action should we perform?
                    switch (data.mceAction)
                    {
                        case 'sayName':
                            if (data.data.name == '')
                            {
                                // display an error
                                editor.windowManager.alert('You need to enter your name.');
                            }
                            else
                            {
                                // say hello
                                editor.windowManager.alert('Hi there ' + data.data.name + ' - nice to meet you!');

                                // close the window
                                instance.close();
                            }
                            break;
                        case 'anotherAction':
                            break;
                        // ...
                        // etc
                    }
                }
            };

            /**
             * Custom command: imgmanagerCommand
             *
             * This is a simple demonstration of a custom command that will display an alert to the user, and insert
             * some content in to the editor.
             *
             * If no content is provided, an error alert is shown.
             */
            editor.addCommand('imgmanagerCommand', function (ui, value) {
                if (value != '')
                {
                    src = value ;
                }
            });

            /**
             * Custom command: getTinyMceContent
             *
             * This command demonstrates how your TinyMCE plugin can send a message to the URL Dialog using the
             * api.sendMessage call.
             *
             * "api" is set when the openUrl function is called - so this won't run until the dialog is actually open.
             */
            editor.addCommand('getTinymceContent', function (ui, value) {
                if (_api !== false)
                {
                    // send a message
                    _api.sendMessage({
                        // this is purely used as an example to show that multiple (and custom)
                        // parameters can be sent using sendMessage
                        'param1': 'My Param',

                        // simply get the editor's content
                        'content': editor.getContent()
                    }, '*');
                    /*
                     *
                     * Note:
                     * This is specifying a target origin as a wildcard ("*") for demonstration purposes.
                     * When using this in your own projects, make sure to specify the origin.
                     *
                     * Refer to:
                     * https://www.tiny.cloud/docs/ui-components/urldialog/#urldialogmessaging
                     *
                     */
                }
            });

            // Define the Toolbar button
            editor.ui.registry.addButton('imgmanager', {
                text: "Inserir Imagem",
                icon: 'gallery',
                onAction: () => {
                    _api = editor.windowManager.openUrl(_urlDialogConfig)
                }
            });

            // Return details to be displayed in TinyMCE's "Help" plugin, if you use it
            // This is optional.

        });
    }());
})();